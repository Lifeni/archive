<!DOCTYPE html>
<html lang="zh-hans">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Docker 搭建开发环境</title>
<link rel="stylesheet" href="../static/css/markdown.css">
</head>
<body>
<article class="markdown-body">
<h1 id="docker-搭建开发环境">Docker 搭建开发环境</h1>
<p>📌 在 Docker 中安装部署 Nginx / Node.js 等</p>
<p>💿 以下均以 CentOS 7.6 64位 为例，命令均以 root 执行</p>
<h2 id="安装-docker">安装 Docker</h2>
<p>官方文档：<a href="https://docs.docker.com/install/linux/docker-ce/centos/#install-using-the-repository">Get Docker Engine - Community for CentOS | Docker Documentation</a></p>
<p>官方提供了三种安装方法，这里采用第一种：使用 Repository 安装。</p>
<ol>
<li><p>安装必要的包。</p>
<pre><code class="language-bash"><span class="hljs-attr">yum</span> <span class="hljs-string">install -y yum-utils \
device-mapper-persistent-data \
lvm2</span></code></pre>
</li>
<li><p>设定 Repository。</p>
<pre><code class="language-bash">yum-config-manager \
--<span class="hljs-built_in">add</span>-repo \
http<span class="hljs-variable">s:</span>//download.docker.<span class="hljs-keyword">com</span>/linux/centos/docker-<span class="hljs-keyword">ce</span>.repo</code></pre>
</li>
<li><p>安装 Docker Engine - Community。</p>
<pre><code class="language-bash">yum install docker-<span class="hljs-keyword">ce</span> docker-<span class="hljs-keyword">ce</span>-cli containerd.io</code></pre>
</li>
<li><p>启动 Docker。</p>
<pre><code class="language-bash">systemctl <span class="hljs-literal">start</span> docker</code></pre>
</li>
<li><p>使用 hello-world 镜像测试。</p>
<pre><code class="language-bash">docker <span class="hljs-keyword">run</span><span class="bash"> hello-world</span></code></pre>
</li>
</ol>
<h2 id="基本操作">基本操作</h2>
<p>使用 <code>docker --help</code> 查看帮助。</p>
<h3 id="配置国内镜像">配置国内镜像</h3>
<p>可以使用下面给出的这个，也可以用 阿里云 提供的加速服务，配置可以参考：<a href="https://help.aliyun.com/document_detail/60750.html">官方镜像加速_快速入门_容器镜像服务-阿里云</a>，目前这个服务是免费的。</p>
<pre><code class="language-bash">vim <span class="hljs-meta-keyword">/etc/</span>docker/daemmon.json

<span class="hljs-meta"># 添加下面这句：</span>
<span class="hljs-meta"># {<span class="hljs-string">"registry-mirrors"</span>:[<span class="hljs-string">"https://registry.docker-cn.com"</span>]}</span>

systemctl daemon-reload
systemctl restart docker</code></pre>
<h3 id="查看版本信息">查看版本信息</h3>
<pre><code class="language-bash">docker <span class="hljs-keyword">version</span>        <span class="hljs-comment"># 查看详细版本信息</span>
docker --<span class="hljs-keyword">version</span>     <span class="hljs-comment"># 查看简单版本信息</span>
docker -v             <span class="hljs-comment"># 同上</span>
docker <span class="hljs-literal">inf</span>o            <span class="hljs-comment"># 显示系统相关信息</span></code></pre>
<h3 id="镜像">镜像</h3>
<p>镜像和虚拟机中的镜像类似，可以用来创建容器。</p>
<pre><code class="language-bash"><span class="hljs-comment"># 搜索镜像</span>
<span class="hljs-attr">docker</span> <span class="hljs-string">search nginx</span>
<span class="hljs-comment"># 获取镜像，默认为 latest</span>
<span class="hljs-attr">docker</span> <span class="hljs-string">pull nginx</span>
<span class="hljs-comment"># 查看已安装镜像</span>
<span class="hljs-attr">docker</span> <span class="hljs-string">images</span>
<span class="hljs-comment"># 移除镜像，需要先移除使用镜像的容器</span>
<span class="hljs-attr">docker</span> <span class="hljs-string">rmi hello-world</span>
<span class="hljs-comment"># 设置标签 test</span>
<span class="hljs-attr">docker</span> <span class="hljs-string">tag 231d40e811cd author/nginx:test</span></code></pre>
<p>可以根据容器来创建一个镜像，这里使用命令创建，另外可以使用 Dockerfile 文件创建。</p>
<pre><code class="language-bash"><span class="hljs-comment"># 描述信息 作者 容器ID 目标镜像名:TAG</span>
docker commit -m=<span class="hljs-string">"description"</span> -<span class="hljs-keyword">a</span>=<span class="hljs-string">"author"</span> <span class="hljs-number">231</span>d40e811cd author/nginx:<span class="hljs-built_in">new</span></code></pre>
<p>之后运行 <code>docker images</code> 可以看到新的镜像。</p>
<h3 id="容器">容器</h3>
<p>容器是镜像的实例。</p>
<pre><code class="language-bash"><span class="hljs-comment"># 启动容器 -i 交互式操作 -t 终端 镜像名 命令</span>
docker run -it ubuntu <span class="hljs-regexp">/bin/</span>bash
<span class="hljs-comment"># 退出终端</span>
<span class="hljs-keyword">exit</span>
<span class="hljs-comment"># 查看所有容器</span>
docker ps -a
<span class="hljs-comment"># 停止容器 容器ID</span>
docker stop <span class="hljs-number">231</span>d40e811cd
<span class="hljs-comment"># 启动停止的容器 容器ID</span>
docker start <span class="hljs-number">231</span>d40e811cd
<span class="hljs-comment"># 重启容器 容器ID</span>
docker restart <span class="hljs-number">231</span>d40e811cd
<span class="hljs-comment"># 删除容器 容器ID -f 删除包括运行中的容器</span>
docker rm <span class="hljs-number">79</span>f8c2bcaed3
<span class="hljs-comment"># 复制文件到主机</span>
docker cp ab520f782c4b:<span class="hljs-regexp">/etc/</span>nginx<span class="hljs-regexp">/nginx.conf /</span>home<span class="hljs-regexp">/nginx</span></code></pre>
<p>在启动容器时添加 <code>-d</code> 参数可以在后台运行，此时可以用 <code>exec</code> 命令重新进入。</p>
<pre><code class="language-bash">docker exec -it 231d40e811<span class="hljs-keyword">cd</span> <span class="hljs-string">/bin/bash</span></code></pre>
<p>在 Web 应用中还可以使用以下命令。</p>
<pre><code class="language-bash"><span class="hljs-comment"># -p 设置端口 </span>
docker <span class="hljs-builtin-name">run</span> -d -p 5000:5000 webapp
<span class="hljs-comment"># 查看端口 容器ID</span>
docker<span class="hljs-built_in"> port </span>231d40e811cd
<span class="hljs-comment"># 查看日志 容器ID</span>
docker logs -f 231d40e811cd
<span class="hljs-comment"># 查看进程 容器ID</span>
docker top 231d40e811cd;
<span class="hljs-comment"># 查看配置信息 容器ID</span>
docker inspect ab520f782c4b;</code></pre>
<h2 id="dockerfile">Dockerfile</h2>
<p>✒ 待补充。</p>
<p>案例见 Nodejs 部署部分。</p>
<h2 id="部署nginx">部署Nginx</h2>
<h3 id="安装">安装</h3>
<pre><code class="language-bash"><span class="hljs-comment"># 安装最新版</span>
docker pull nginx:latest

<span class="hljs-comment"># 启动 Nginx</span>
docker run -d <span class="hljs-string">\</span>      <span class="hljs-comment"># 后台运行</span>
-p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> <span class="hljs-string">\</span>            <span class="hljs-comment"># 端口映射 主机:容器</span>
--name nginx-test <span class="hljs-string">\</span>  <span class="hljs-comment"># 命名</span>
nginx</code></pre>
<p>之后访问主机 IP 即可看到 Nginx 的欢迎页面。</p>
<h3 id="配置">配置</h3>
<p>在主机上创建好目录和文件，重定向到容器中即可，我这里同时配置了 SSL，所以会有两个端口。</p>
<ul>
<li><p><code>:ro</code> 表示只读模式。</p>
</li>
<li><p><code>--net=host</code> 表示容器可以直接访问主机上所有的网络信息。</p>
</li>
</ul>
<pre><code class="language-bash">docker run \
--name nginx \
-d -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> -p <span class="hljs-number">443</span>:<span class="hljs-number">443</span> \
--net=host \
-v <span class="hljs-regexp">/home/</span><span class="hljs-string">www:</span><span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nginx/</span>html \
-v <span class="hljs-regexp">/home/</span>nginx<span class="hljs-regexp">/nginx.conf:/</span>etc<span class="hljs-regexp">/nginx/</span>nginx.<span class="hljs-string">conf:</span>ro \
-v <span class="hljs-regexp">/home/</span>nginx<span class="hljs-regexp">/conf.d:/</span>etc<span class="hljs-regexp">/nginx/</span>conf.<span class="hljs-string">d:</span>ro \
-v <span class="hljs-regexp">/home/</span>nginx<span class="hljs-regexp">/cert:/</span>etc<span class="hljs-regexp">/nginx/</span><span class="hljs-string">cert:</span>ro \
-v <span class="hljs-regexp">/home/</span>nginx<span class="hljs-regexp">/log:/</span>var<span class="hljs-regexp">/log/</span>nginx \
nginx</code></pre>
<p>之后可以将镜像导出，以便以后使用（这里导出其实没什么用，因为没有改动，重定向不会被记录到镜像中）。</p>
<pre><code class="language-bash">docker commit <span class="hljs-string">\</span>
--author <span class="hljs-string">"Lifeni"</span> <span class="hljs-string">\</span>
--message <span class="hljs-string">"New Nginx"</span> <span class="hljs-string">\</span>
nginx <span class="hljs-string">\</span>
nginx:v1</code></pre>
<h2 id="部署-nodejs">部署 Node.js</h2>
<p>先获取 Nodejs 镜像，再使用 Dockerfile 配置。</p>
<pre><code class="language-bash">docker pull <span class="hljs-keyword">node</span><span class="hljs-title"></span></code></pre>
<p>在 Nodejs 项目下新建 Dockerfile: </p>
<pre><code class="language-dockerfile"><span class="hljs-keyword">FROM</span> node:latest
<span class="hljs-keyword">RUN</span><span class="bash"> mkdir -p /home/app</span>
<span class="hljs-keyword">WORKDIR</span><span class="bash"> /home/app</span>
<span class="hljs-keyword">COPY</span><span class="bash"> . /home/app</span>
<span class="hljs-keyword">RUN</span><span class="bash"> npm install -d --registry=https://registry.npm.taobao.org</span>
<span class="hljs-keyword">RUN</span><span class="bash"> npm install</span>
<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">2333</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">"npm"</span>, <span class="hljs-string">"start"</span>]</span></code></pre>
<p>之后在项目目录下运行以下命令，构建镜像。</p>
<pre><code class="language-bash">docker build -t <span class="hljs-keyword">node</span><span class="hljs-title">-blog</span> /home/<span class="hljs-keyword">node</span><span class="hljs-title"></span></code></pre>
<p>启动容器。</p>
<pre><code class="language-bash">docker run -d \
-p <span class="hljs-number">2333</span>:<span class="hljs-number">2333</span> \
<span class="hljs-keyword">node</span><span class="hljs-title">-blog</span></code></pre>
<h2 id="部署-tomcat">部署 Tomcat</h2>
<p>只是简单的部署：</p>
<pre><code class="language-bash"><span class="hljs-comment"># 安装</span>
<span class="hljs-attr">docker</span> <span class="hljs-string">pull tomcat</span>
<span class="hljs-comment">
# 运行</span>
 <span class="hljs-attr">docker</span> <span class="hljs-string">run -d \
 -v /root/java/server.war:/usr/local/tomcat/webapps/server.war \
 -p 8080:8080 \
 tomcat</span>
<span class="hljs-comment">
 # 进入 Container</span>
 <span class="hljs-attr">docker</span> <span class="hljs-string">exec -it 59b9517b8a1e /bin/bash</span></code></pre>
</article>
</body>
</html>